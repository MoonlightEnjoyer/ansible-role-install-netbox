---
#PostgreSQL section
- name: Install PostgreSQL
  apt:
    name: postgresql
- name: Create netbox database
  community.postgresql.postgresql_db:
    name: netbox
    owner: netbox
- name: Create psql user netbox
  community.postgresql.postgresql_user:
    login_db: netbox
    name: netbox
    password: TODO

#---
#Redis section
- name: Install Redis
  apt:
    name: redis-server

#---
#Netbox section
- name: Install required packages
  apt:
    name:
      - python3
      - python3-pip
      - python3-venv
      - python3-dev
      - build-essential
      - libxml2-dev
      - libxslt1-dev
      - libffi-dev
      - libpq-dev
      - libssl-dev
      - zlib1g-dev
- name: Download and unpach netbox release archive
  unarchive:
    src: https://github.com/netbox-community/netbox/archive/refs/tags/v4.3.2.tar.gz
    dest: /opt
    remote_src: yes
- name: Create netbox symlink
  file:
    src: /opt/netbox-4.3.2/
    dest: /opt/netbox
    state: link
- name: Create netbox user
  user:
    name: netbox
    group: netbox
    system: true
- name: Change some netbox directories ownership
  file:
    path:
      - /opt/netbox/netbox/media/
      - /opt/netbox/netbox/reports/
      - /opt/netbox/netbox/scripts/
    recurse: yes
    owner: netbox
    group: netbox
#- name: Generate secret key
#  command: python3 /opt/netbox/netbox/generate_secret_key.py
#  register: secret_key
- name: Copy configuration.py template
  template:
    src: templates/configuration.py.j2
    dest: /opt/netbox/netbox/netbox/configuration.py
- name: Run the upgrade script
  command: /opt/netbox/upgrade.sh
# - name: Create a super user
#   command: /opt/netbox/venv/bin/activate && python3 /opt/netbox/netbox/manage.py createsuperuser